include ../mixins

doctype html
html(lang='ru', ng-app='manage', ng-controller='AppCtrl')


    head
        block head
            meta(charset='utf-8')
            title(ng-bind="app.title") JET ENGINE -- A NodeJS CMF...

            block head-links
                link(rel='stylesheet', href='/styles/awesome.css')
                link(rel='stylesheet', href='/styles/awesome-navs.css')
                link(rel='stylesheet', href='/styles/awesome-tabs.css')
                link(rel='stylesheet', href='/styles/awesome-forms.css')
                link(rel='stylesheet', href='/styles/awesome-dialogs.css')
                link(rel='stylesheet', href='/styles/jet.css')

            block head-scripts
                script(src='/scripts/libs/jquery/jquery.min.js')
                script(src='/scripts/libs/angular/angular.min.js')
                script(src='/scripts/libs/angular/angular-animate.min.js')
                script(src='/scripts/libs/angular/angular-resource.min.js')
                script(src='/scripts/libs/angular/angular-route.min.js')
                script(src='/scripts/awesome.js')

                script
                    :coffee



                        app= angular.module 'app', []

                        app.constant 'debug', console



                        app.factory 'User', ($resource) ->
                            $resource '/api/v1/user/:action', {},
                                login:
                                    method: 'post'
                                    params:
                                        action: 'login'

                                logout:
                                    method: 'post'
                                    params:
                                        action: 'logout'

                                registration:
                                    method: 'post'
                                    params:
                                        action: 'registration'


                        app.controller 'AppHeadCtrl', ($rootScope, $scope, User) ->
                            $rootScope.user= User.get (user) ->
                                    console.log 'удалось получить пользователя', user
                            ,   (err) ->
                                    console.log 'не удалось получить пользователя', err


                        app.controller 'LoginAppDialogCtrl', ($rootScope, $scope, User, $window) ->
                            if not $rootScope.user
                                $rootScope.user= new User
                            $scope.login= (loginForm) ->
                                $scope.user.$login (user) ->
                                    #user.pass= loginForm.password.$modelValue
                                    $window.location.href= '../engine/'
                                    $scope.notify 'done', 'authentication'
                                , (err) ->
                                    $scope.user.pass= ''
                                    $scope.notify 'error', err

                        app.controller 'ViewCtrl', ($scope) ->
                            $scope.edit= {
                                dialog: {
                                    overlay: null
                                }
                            }
                            $scope.showEditDialog= (type) ->
                                $scope.edit.dialog.overlay= type

                        app.controller 'EditDialogCtrl', ($scope) ->
                            $scope.hideEditDialog= () ->
                                $scope.edit.dialog.overlay= null



    body(ng-controller='ViewCtrl'): block body
        .b-app
            header.b-app--head(ng-controller="AppHeadCtrl"): block app-head

                .navbar.navbar-static-top

                    a.navbar-brand(ng-class="{active:'index'==app.route.name}", ng-href="{{app.prefix}}/")
                        span jet engine
                        sup  {{app.version}}

                    .nav-collapse

                        ul.nav.navbar-nav.pull-left

                            li(ng-class="{active:'design'==app.route.name}"): a(ng-href="{{app.prefix}}/design")
                                u Design

                            li(ng-class="{active:'develop'==app.route.name}"): a(ng-href="{{app.prefix}}/develop")
                                u Develop

                            li(ng-class="{active:'apps'==app.route.name}"): a(ng-href="{{app.prefix}}/apps")
                                u Applications

                        ul.nav.navbar-nav.pull-right(ng-if="user && user.name && user.name != 'anonymous'")

                            li: a(href='/project/')
                                u Управление проектом

                            li: a(href='/engine/')
                                u Управление системой

                            li: a(ng-href="/user")
                                u {{user.name}}

                        ul.nav.navbar-nav.pull-right(ng-if="!user || !user.name || user.name == 'anonymous'")

                            li(ng-class="{active:'login'==app.dialog.overlay}"): a(ng-href="{{app.prefix}}/login")
                                u Sign In

                            li(ng-class="{active:'login'==app.dialog.overlay}"): a(ng-href="{{app.prefix}}/registration")
                                u Registration

            main.b-app--body: .row
                style
                    :less
                        .layout-landing {
                            margin: 10% 15%;
                        }

                .b-app--main(ng-view)

                +bDialog('app')
                    +bDialogArea()
                    +bDialogMain()

                        .b-include-dialog(ng-if="dialog.overlay && dialog.templateUrl"): .b-include(ng-include="dialog.templateUrl")

                        .b-users-login-dialog(ng-if="'login'==dialog.overlay", ng-controller="LoginAppDialogCtrl")
                            +bDialogHead()
                                i.icon-signin
                                span Вход в центр управления
                                +bDialogActs()
                                    +bDialogActClose()
                            +bDialogTabs()
                                ul.nav.nav-tabs.pull-left
                                    li(ng-class="{active:!dialog.tab}"): a(ng-href="{{app.prefix}}/login") Вход в кабинет
                                    li(ng-class="{active:'console'==dialog.tab}"): a(ng-href="{{app.prefix}}/login/console") Вход в консоль
                            +bDialogBody()
                                .row
                                    .col-xs-12.col-sm-offset-2.col-sm-8.col-lg-offset-2.col-lg-5
                                        form.form.form-lg(name='loginPasswordForm', ng-submit='login(loginPasswordForm)').dialog-form
                                            legend Вход с паролем
                                            input.input(type='text', name='username', placeholder='Пользователь', required, ng-model='user.username')
                                            input.input(type='password', name='password', placeholder='Пароль', required, ng-model='user.password')
                                            .form-acts
                                                .row
                                                    .col-xs-12
                                                        button.b-btn.b-btn-primary.btn-block(type='submit', ng-disabled='!loginPasswordForm.$valid')
                                                            i.icon-signin
                                                            span  Войти в кабинет
                                    .col-xs-12.col-sm-offset-2.col-sm-8.col-lg-offset-0.col-lg-3
                                        form.form.form-lg.dialog-form
                                            legend Вход с помощью
                                            input(type='hidden', ng-model="lol", required)
                                            a.btn.btn-link(href='/auth/github'): u Вход c Github
                                            a.btn.btn-link(href='/auth/google'): u Вход c Google


            menu.b-app--notifications(ng-if="app.notify.notifications.length")
                .b-app--notification(ng-repeat="notification in app.notify.notifications")
                    p.note(ng-if="'error'==notification.type") {{notification}}

            section.b-app--demo  

            footer.b-app--foot
                .navbar
                    a.navbar-brand(ng-class="{active:'index'==app.route.name}", ng-href="{{app.prefix}}/")
                        span jet engine
                        sup  {{app.version}}
